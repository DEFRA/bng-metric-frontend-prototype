{% extends "layouts/main.html" %}

{% set pageName="Define Red Line Boundary" %}

{% block pageTitle %}
  Define Red Line Boundary - GOV.UK Prototype Kit
{% endblock %}

{% block beforeContent %}
  <a href="/" class="govuk-back-link">Back</a>
{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/OrdnanceSurvey/os-api-branding@latest/os-api-branding.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.6.0/ol.css" />
{% endblock %}

{% block content %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h1 class="govuk-heading-xl">
      Define Red Line Boundary
    </h1>
    
    <p class="govuk-body">
      Use the map to draw your site's red line boundary with intelligent snapping to buildings, roads, waterlines, and railways.
    </p>

    <details class="govuk-details">
      <summary class="govuk-details__summary">
        <span class="govuk-details__summary-text">
          How to draw a polygon
        </span>
      </summary>
      <div class="govuk-details__text">
        <h3 class="govuk-heading-s">Drawing a polygon:</h3>
        <ol class="govuk-list govuk-list--number">
          <li><strong>Zoom in to at least zoom level 14</strong> - Watch the zoom indicator above the map turn green</li>
          <li>Wait for snapping data to load (check console for "snapping is now active!" message)</li>
          <li><strong>Click the "Start Drawing" button</strong> - A circle will appear next to your cursor</li>
          <li>Move your mouse near features - the circle will turn <strong style="color: #ff8c00;">orange</strong> and jump to the nearest edge when snapping</li>
          <li>Click to place each vertex at the snapped position (including the first point!)</li>
          <li>Hover over the first vertex (it will turn <strong style="color: #ff0000;">large and red</strong>) and click to close the polygon</li>
        </ol>
        <h3 class="govuk-heading-s govuk-!-margin-top-4">Editing a completed polygon:</h3>
        <ol class="govuk-list govuk-list--number">
          <li>After closing a polygon, <strong>hover over any vertex</strong> - it will enlarge slightly</li>
          <li><strong>Click and drag</strong> the vertex to a new position - snapping still works!</li>
          <li>Release to place the vertex at the new (snapped) location</li>
          <li>To <strong>add a new vertex</strong>, hover over the polygon edge (red line) - a white circle appears</li>
          <li><strong>Click the white circle</strong> to insert a new vertex at that position</li>
          <li>The <strong>area in hectares</strong> updates automatically as you edit</li>
          <li>Click <strong>"Clear Polygon"</strong> to remove it and draw a new one</li>
        </ol>
        <p class="govuk-body">The drawing tool automatically snaps to OS Zoomstack features:</p>
        <ul class="govuk-list govuk-list--bullet">
          <li>Buildings (Local Buildings)</li>
          <li>Roads (Local, Regional, and National)</li>
          <li>Waterlines</li>
          <li>Railways</li>
          <li>Greenspace</li>
          <li>Woodland</li>
        </ul>
        <div class="govuk-inset-text govuk-!-margin-top-4">
          <strong>Visual feedback:</strong>
          <ul class="govuk-list govuk-list--bullet govuk-!-margin-top-2">
            <li><strong style="color: #0096ff;">Blue circle</strong> = cursor position (no snap)</li>
            <li><strong style="color: #ff8c00;">Orange circle (larger)</strong> = snapped to a feature!</li>
            <li><strong style="color: #ff0000;">Large red circle</strong> = hover over first vertex to close polygon</li>
          </ul>
        </div>
        <p class="govuk-body govuk-!-margin-top-2">
          <strong>Tip:</strong> Open your browser console (F12) to see detailed status messages and snap events.
        </p>
      </div>
    </details>
  </div>

  <div class="govuk-grid-column-one-third">
    <div class="govuk-button-group">
      <button type="button" class="govuk-button" id="start-drawing">
        Start Drawing
      </button>
      <button type="button" class="govuk-button govuk-button--warning" id="cancel-drawing" style="display: none;">
        Cancel Drawing
      </button>
      <button type="button" class="govuk-button govuk-button--secondary" id="clear-polygon" style="display: none;">
        Clear Polygon
      </button>
      <button type="button" class="govuk-button" id="save-boundary" disabled>
        Save Boundary
      </button>
      <button type="button" class="govuk-button govuk-button--secondary" id="export-geojson">
        Export GeoJSON
      </button>
    </div>
    
    <div class="govuk-form-group govuk-!-margin-top-4">
      <div class="govuk-checkboxes govuk-checkboxes--small">
        <div class="govuk-checkboxes__item">
          <input class="govuk-checkboxes__input" id="snap-enabled" name="snap-enabled" type="checkbox" checked>
          <label class="govuk-label govuk-checkboxes__label" for="snap-enabled">
            Enable snapping to features
          </label>
        </div>
      </div>
      <div class="govuk-hint govuk-!-margin-top-2">
        When enabled, vertices snap to buildings, roads, and other features
      </div>
    </div>
    
    <div id="status-message" class="govuk-notification-banner" role="region" aria-labelledby="status-title" style="display: none;">
      <div class="govuk-notification-banner__header">
        <h2 class="govuk-notification-banner__title" id="status-title">
          Information
        </h2>
      </div>
      <div class="govuk-notification-banner__content">
        <p class="govuk-notification-banner__heading" id="status-text">
          Status message
        </p>
      </div>
    </div>
    
    <div id="area-display" class="govuk-!-margin-top-4" style="display: none;">
      <h3 class="govuk-heading-s">Polygon Area</h3>
      <p class="govuk-body" style="font-size: 24px; font-weight: bold; color: #dc0000;">
        <span id="area-value">--</span> hectares
      </p>
      <p class="govuk-hint">
        (<span id="area-acres">--</span> acres)
      </p>
    </div>
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <div class="govuk-!-margin-bottom-2">
      <strong class="govuk-tag" id="zoom-display" style="font-size: 16px; padding: 8px 12px;">
        Zoom: --
      </strong>
      <span class="govuk-body-s govuk-!-margin-left-2" id="snap-status">
        Snapping disabled (zoom to level 14+)
      </span>
    </div>
    <div id="map" class="os-map-container" data-mode="red-line-boundary"></div>
  </div>
</div>

{% endblock %}

{% block pageScripts %}
  <script src="https://cdn.jsdelivr.net/gh/OrdnanceSurvey/os-api-branding@latest/os-api-branding.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.0/dist/proj4.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ol@v10.6.0/dist/ol.js"></script>
  <script src="https://unpkg.com/ol-mapbox-style@13.1.0/dist/olms.js"></script>
  <script>
    // Register EPSG:27700 (British National Grid) projection
    proj4.defs('EPSG:27700', '+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs');
    ol.proj.proj4.register(proj4);
    console.log('âœ“ EPSG:27700 projection registered');
  </script>
  <script src="/public/javascripts/snapping.js"></script>
  <script src="/public/javascripts/map.js"></script>
{% endblock %}
