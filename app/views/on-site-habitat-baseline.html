{% extends "layouts/map-layout.html" %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/textarea/macro.njk" import govukTextarea %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}

{% set pageName="On-site Habitat Baseline Map" %}

{% block pageTitle %}
  On-site Habitat Baseline Map - GOV.UK Prototype Kit
{% endblock %}

{% block backLink %}
  {{ govukBackLink({
    href: "/define-red-line-boundary"
  }) }}
{% endblock %}

{% block mapAttributes %}data-mode="habitat-parcels" data-boundary-url="/api/red-line-boundary"{% endblock %}

{% block leftPanelContent %}
  <h2 class="govuk-heading-m">Drawing Controls</h2>
  
  <ul class="map-controls-list">
    <li>
      <a href="#" id="start-drawing" data-action="add">Draw Parcel</a>
    </li>
    <li>
      <a href="#" id="start-fill-parcel" data-action="fill-parcel">Fill Parcel</a>
    </li>
    <li style="display: none;">
      <a href="#" id="cancel-drawing" data-action="cancel">Cancel Drawing</a>
    </li>
    <li style="display: none;">
      <a href="#" id="finish-fill-parcel" data-action="finish-fill-parcel">Finish Fill</a>
    </li>
    <li>
      <a href="#" id="start-slice" data-action="slice">Slice</a>
    </li>
    <li style="display: none;">
      <a href="#" id="cancel-slice" data-action="cancel-slice">Cancel Slice</a>
    </li>
    <li>
      <a href="#" id="save-parcels" class="disabled" data-action="save">Save Parcels</a>
    </li>
  </ul>
  
  <div class="govuk-form-group govuk-!-margin-top-4">
    <fieldset class="govuk-fieldset">
      <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
        Snapping options
      </legend>
      <div class="govuk-checkboxes govuk-checkboxes--small">
        <div class="govuk-checkboxes__item">
          <input class="govuk-checkboxes__input" id="snap-enabled" name="snap-enabled" type="checkbox" checked>
          <label class="govuk-label govuk-checkboxes__label" for="snap-enabled">
            Snap to OS features
          </label>
        </div>
      </div>
      <hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-top-2 govuk-!-margin-bottom-2">
      <p class="govuk-label govuk-label--s govuk-!-margin-bottom-2">Boundary snapping:</p>
      <div class="govuk-checkboxes govuk-checkboxes--small">
        <div class="govuk-checkboxes__item">
          <input class="govuk-checkboxes__input" id="snap-boundary-vertices" name="snap-boundary-vertices" type="checkbox" checked>
          <label class="govuk-label govuk-checkboxes__label" for="snap-boundary-vertices">
            Snap to boundary corners
          </label>
        </div>
        <div class="govuk-checkboxes__item">
          <input class="govuk-checkboxes__input" id="snap-boundary-edges" name="snap-boundary-edges" type="checkbox" checked>
          <label class="govuk-label govuk-checkboxes__label" for="snap-boundary-edges">
            Snap to boundary edges
          </label>
        </div>
      </div>
      <hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-top-2 govuk-!-margin-bottom-2">
      <p class="govuk-label govuk-label--s govuk-!-margin-bottom-2">Parcel snapping:</p>
      <div class="govuk-checkboxes govuk-checkboxes--small">
        <div class="govuk-checkboxes__item">
          <input class="govuk-checkboxes__input" id="snap-parcel-vertices" name="snap-parcel-vertices" type="checkbox" checked>
          <label class="govuk-label govuk-checkboxes__label" for="snap-parcel-vertices">
            Snap to parcel corners
          </label>
        </div>
        <div class="govuk-checkboxes__item">
          <input class="govuk-checkboxes__input" id="snap-parcel-edges" name="snap-parcel-edges" type="checkbox" checked>
          <label class="govuk-label govuk-checkboxes__label" for="snap-parcel-edges">
            Snap to parcel edges
          </label>
        </div>
      </div>
    </fieldset>
    <div class="govuk-hint govuk-!-margin-top-2">
      Toggle individual snap types to isolate specific targets
    </div>
  </div>

  <hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-top-4 govuk-!-margin-bottom-4">

  <div class="govuk-!-margin-bottom-2">
    <strong class="govuk-tag" id="zoom-display" style="font-size: 16px; padding: 8px 12px;">
      Zoom: --
    </strong>
  </div>
  <div>
    <span class="govuk-body-s" id="snap-status">
      Snapping disabled (zoom to level 14+)
    </span>
  </div>
  
  <div id="status-message" class="govuk-notification-banner govuk-!-margin-top-4" role="region" aria-labelledby="status-title" style="display: none; position: static; box-shadow: none; transform: none; left: auto;">
    <div class="govuk-notification-banner__header">
      <h2 class="govuk-notification-banner__title" id="status-title">
        Information
      </h2>
    </div>
    <div class="govuk-notification-banner__content">
      <p class="govuk-notification-banner__heading" id="status-text">
        Status message
      </p>
    </div>
  </div>
{% endblock %}

{% block rightPanelContent %}
  <h1 class="govuk-heading-l">
    On-site Habitat Baseline Map
  </h1>
  
  <p class="govuk-body">
    Draw habitat parcels within your red line boundary. Each parcel must be completely within the boundary and must not overlap with other parcels.
  </p>

  <div id="boundary-area-display" class="govuk-!-margin-top-4" style="background: #f3f2f1; padding: 15px; border-left: 4px solid #d4351c;">
    <h3 class="govuk-heading-s govuk-!-margin-bottom-2">Red Line Boundary</h3>
    <p class="govuk-body-s govuk-!-margin-bottom-0">
      <strong>Total site area:</strong> <span id="boundary-area">--</span> hectares
    </p>
  </div>

  <div id="area-display" class="govuk-!-margin-top-4" style="display: none;">
    <h3 class="govuk-heading-s">Current Parcel Area</h3>
    <p class="govuk-body" style="font-size: 24px; font-weight: bold; color: #1d70b8;">
      <span id="area-value">--</span> hectares
    </p>
    <p class="govuk-hint">
      (<span id="area-acres">--</span> acres)
    </p>
  </div>

  <div id="parcels-list" class="govuk-!-margin-top-4">
    <h3 class="govuk-heading-s">Habitat Parcels</h3>
    <ul class="govuk-list" id="parcels-list-items">
      <li class="govuk-body-s" style="color: #505a5f;">No parcels drawn yet</li>
    </ul>
    <hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-top-2 govuk-!-margin-bottom-2">
    <p class="govuk-body-s govuk-!-margin-bottom-1">
      <strong>Total parcels area:</strong> <span id="total-area">0.00</span> hectares
    </p>
    <div id="remaining-area-container">
      <p class="govuk-body-s govuk-!-margin-bottom-0">
        <strong>Remaining to assign:</strong> <span id="remaining-area-value" style="color: #d4351c;">--</span> hectares
      </p>
      <p class="govuk-body-s govuk-!-margin-bottom-0" id="remaining-area-warning" style="color: #d4351c; display: none;">
        (exceeds boundary)
      </p>
    </div>
  </div>

  <hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-top-4 govuk-!-margin-bottom-4">

  <!-- Habitat Attribution Panel -->
  <div id="habitat-attribution-panel">
    <h3 class="govuk-heading-s">Baseline Habitat Data</h3>
    
    <!-- No selection message -->
    <div id="no-selection-message" class="govuk-inset-text">
      Select a habitat parcel to assign baseline habitat data
    </div>

    <!-- Attribution form (hidden until parcel selected) -->
    <div id="attribution-form" style="display: none;">
      
      <!-- Selected parcel header -->
      <p class="govuk-body govuk-!-margin-bottom-3">
        <strong id="selected-parcel-header">Parcel 1</strong>
        <button type="button" class="govuk-link" id="deselect-parcel-btn" style="margin-left: 10px; border: none; background: none; cursor: pointer; color: #1d70b8;">
          Deselect
        </button>
      </p>

      <!-- Validation error summary -->
      <div id="validation-summary" class="govuk-error-summary" data-module="govuk-error-summary" style="display: none;">
        <div role="alert">
          <h2 class="govuk-error-summary__title">
            Missing required information
          </h2>
          <div class="govuk-error-summary__body">
            <ul class="govuk-list govuk-error-summary__list">
            </ul>
          </div>
        </div>
      </div>

      <!-- Irreplaceable habitat warning banner -->
      <div id="irreplaceable-warning" class="govuk-warning-text govuk-!-margin-bottom-4" style="display: none;">
        <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
        <strong class="govuk-warning-text__text">
          <span class="govuk-visually-hidden">Warning</span>
          Irreplaceable habitats are excluded from BNG calculations and require bespoke compensation.
        </strong>
      </div>

      <!-- Broad Habitat Type -->
      <div class="govuk-form-group">
        <label class="govuk-label govuk-label--s" for="broad-habitat">
          Broad Habitat Type
        </label>
        <select class="govuk-select" id="broad-habitat" name="broad-habitat">
          <option value="">Select broad habitat</option>
          <option value="Cropland">Cropland</option>
          <option value="Grassland">Grassland</option>
          <option value="Heathland and shrub">Heathland and shrub</option>
          <option value="Woodland and forest">Woodland and forest</option>
          <option value="Lakes">Lakes</option>
          <option value="Sparsely vegetated land">Sparsely vegetated land</option>
          <option value="Urban">Urban</option>
          <option value="Individual trees">Individual trees</option>
          <option value="Intertidal sediment">Intertidal sediment</option>
          <option value="Intertidal hard structures">Intertidal hard structures</option>
        </select>
      </div>

      <!-- Habitat Type -->
      <div class="govuk-form-group">
        <label class="govuk-label govuk-label--s" for="habitat-type">
          Habitat Type
        </label>
        <select class="govuk-select" id="habitat-type" name="habitat-type" disabled>
          <option value="">Select habitat type</option>
        </select>
      </div>

      <!-- Irreplaceable Habitat -->
      <div class="govuk-form-group">
        <fieldset class="govuk-fieldset">
          <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
            Irreplaceable Habitat?
          </legend>
          <div class="govuk-radios govuk-radios--small govuk-radios--inline">
            <div class="govuk-radios__item">
              <input class="govuk-radios__input" id="irreplaceable-yes" name="irreplaceable" type="radio" value="yes">
              <label class="govuk-label govuk-radios__label" for="irreplaceable-yes">
                Yes
              </label>
            </div>
            <div class="govuk-radios__item">
              <input class="govuk-radios__input" id="irreplaceable-no" name="irreplaceable" type="radio" value="no" checked>
              <label class="govuk-label govuk-radios__label" for="irreplaceable-no">
                No
              </label>
            </div>
          </div>
        </fieldset>
      </div>

      <!-- Area (read-only) -->
      <div class="govuk-form-group">
        <label class="govuk-label govuk-label--s">
          Area (hectares)
        </label>
        <p class="govuk-body" style="font-weight: bold;">
          <span id="parcel-area-readonly">--</span> ha
        </p>
      </div>

      <!-- Distinctiveness (read-only metadata) -->
      <div class="govuk-form-group">
        <label class="govuk-label govuk-label--s">
          Distinctiveness
        </label>
        <p class="govuk-body">
          <span id="distinctiveness-display" class="govuk-tag govuk-tag--grey">Not set</span>
        </p>
      </div>

      <!-- Condition -->
      <div class="govuk-form-group">
        <label class="govuk-label govuk-label--s" for="condition">
          Condition
        </label>
        <div id="condition-hint" class="govuk-hint" style="display: none;">
          Intermediate condition categories require ecological justification.
        </div>
        <select class="govuk-select" id="condition" name="condition" disabled>
          <option value="">Select condition</option>
          <option value="Good">Good</option>
          <option value="Fairly Good">Fairly good</option>
          <option value="Moderate">Moderate</option>
          <option value="Fairly Poor">Fairly poor</option>
          <option value="Poor">Poor</option>
          <option value="N/A - Other">N/A - Other</option>
        </select>
      </div>

      <!-- Strategic Significance -->
      <div class="govuk-form-group">
        <label class="govuk-label govuk-label--s" for="strategic-significance">
          Strategic Significance
        </label>
        <select class="govuk-select" id="strategic-significance" name="strategic-significance">
          <option value="Low">Low Strategic Significance</option>
          <option value="Medium">Medium Strategic Significance</option>
          <option value="High">High Strategic Significance</option>
        </select>
      </div>

      <!-- User Comments -->
      <div class="govuk-form-group">
        <label class="govuk-label govuk-label--s" for="user-comments">
          User Comments
        </label>
        <div id="comments-hint" class="govuk-hint">
          Required for irreplaceable habitats. Use this space to provide additional context or justification.
        </div>
        <textarea class="govuk-textarea" id="user-comments" name="user-comments" rows="3"></textarea>
      </div>

    </div>
  </div>

  <hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-top-4 govuk-!-margin-bottom-4">

  <details class="govuk-details">
    <summary class="govuk-details__summary">
      <span class="govuk-details__summary-text">
        How to create habitat parcels
      </span>
    </summary>
    <div class="govuk-details__text">
      <p class="govuk-body">You can create habitat parcels using two methods:</p>

      <h3 class="govuk-heading-s govuk-!-margin-top-4">Option 1: Fill Parcel (recommended)</h3>
      <p class="govuk-body">Select existing OS map features within your boundary:</p>
      <ol class="govuk-list govuk-list--number">
        <li><strong>Click "Fill Parcel"</strong> to start selection mode</li>
        <li>Click on a <strong>field, land area, or other OS polygon</strong> within the boundary</li>
        <li>The selected area will be added as a new habitat parcel</li>
        <li>Continue clicking to add more parcels</li>
        <li>Click <strong>"Finish Fill"</strong> when done to use other tools (Slice, Draw)</li>
      </ol>
      <div class="govuk-inset-text">
        <strong>Note:</strong> Only polygons that are completely within the red-line boundary can be selected.
      </div>

      <h3 class="govuk-heading-s govuk-!-margin-top-4">Option 2: Draw Parcel</h3>
      <p class="govuk-body">Manually draw parcels with intelligent snapping:</p>
      <ol class="govuk-list govuk-list--number">
        <li>Your red line boundary is shown on the map (red dashed line)</li>
        <li><strong>Click "Draw Parcel"</strong> to start drawing a new habitat parcel</li>
        <li>Draw the parcel using intelligent snapping to ensure precise boundaries</li>
        <li>The parcel must be <strong>completely within</strong> the red line boundary</li>
        <li>Parcels must <strong>not overlap</strong> with each other</li>
        <li>You can draw <strong>multiple parcels</strong> - each will be shown in a different colour</li>
      </ol>
      <h3 class="govuk-heading-s govuk-!-margin-top-4">Visual indicators:</h3>
      <ul class="govuk-list govuk-list--bullet">
        <li><strong style="color: #d4351c;">Small red dots</strong> = boundary corners (always visible as reference points)</li>
        <li><strong style="color: #d4351c;">Large red circle</strong> = cursor snapping to boundary corner (highest priority)</li>
        <li><strong style="color: #ae2573;">Large magenta circle</strong> = cursor snapping to parcel corner (exact match)</li>
        <li><strong style="color: #ff8c00;">Orange circle</strong> = snapping to edge or OS feature</li>
        <li><strong style="color: #0096ff;">Small blue circle</strong> = no snapping (free placement)</li>
      </ul>
      <div class="govuk-inset-text govuk-!-margin-top-2">
        <strong>Tip:</strong> Boundary and parcel corner snapping has the highest priority - it will always trigger before OS features for precise alignment.
      </div>
      <h3 class="govuk-heading-s govuk-!-margin-top-4">Managing parcels:</h3>
      <ul class="govuk-list govuk-list--bullet">
        <li>Each parcel's area is displayed in the parcels list</li>
        <li>Click on a parcel in the list to highlight it on the map</li>
        <li>Use the delete button to remove a parcel</li>
        <li>The total area of all parcels is shown below the list</li>
      </ul>
      <h3 class="govuk-heading-s govuk-!-margin-top-4">Slicing parcels:</h3>
      <p class="govuk-body-s">Use the <strong>Slice</strong> tool to split the boundary or an existing parcel into two separate parcels:</p>
      <ol class="govuk-list govuk-list--number">
        <li><strong>Click "Slice"</strong> to enter slice mode</li>
        <li>Click on a <strong>vertex (corner point)</strong> of the red-line boundary or an existing parcel</li>
        <li>A preview line will appear from your selected starting point</li>
        <li>Click on a <strong>different vertex</strong> of the <strong>same polygon</strong> to complete the slice</li>
        <li>Two new parcels will be created from the split</li>
      </ol>
      <div class="govuk-inset-text govuk-!-margin-top-2">
        <strong>Slice rules:</strong>
        <ul class="govuk-list govuk-list--bullet govuk-!-margin-top-2">
          <li>Both start and end points must be on vertices (corner points)</li>
          <li>Both points must be on the same polygon</li>
          <li>Adjacent vertices cannot be used (would create invalid shapes)</li>
          <li>Press <strong>Escape</strong> or click "Cancel Slice" to cancel</li>
        </ul>
      </div>
      <div class="govuk-inset-text govuk-!-margin-top-4">
        <strong>Validation rules:</strong>
        <ul class="govuk-list govuk-list--bullet govuk-!-margin-top-2">
          <li>All parcels must be inside the red line boundary</li>
          <li>Parcels cannot overlap with each other</li>
          <li>Invalid parcels will be rejected with an error message</li>
        </ul>
      </div>
    </div>
  </details>
{% endblock %}
